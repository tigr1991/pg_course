# ДЗ 3

## 1 
```sql
DROP TABLE IF EXISTS test2;
CREATE TABLE test2(id SERIAL PRIMARY KEY, val TEXT);
INSERT INTO test2 (val)
SELECT md5(random()::text)
FROM generate_series(1, 1000000);
```

## 2
```sql
SELECT pg_size_pretty(pg_table_size('test2')) AS table_size;
```
ответ: **65 MB**

## 3 
выполнение скрипта (x5, сделано доп задание)

## 4
```sql
SELECT n_dead_tup
FROM pg_stat_user_tables
WHERE relname = 'test2';
```
Ответ: **5000000**

```sql
SELECT last_autovacuum
FROM pg_stat_user_tables
WHERE relname = 'test2';
```
Ответ: **2024-10-14 15:54:06.4708+00** (запуск обновления строк был позже)

Размер таблицы: **407 MB**

## 5

Ответ: **2024-10-14 2024-10-14 15:56:34.528168+00** (прошёл автовакуум после обновления строк)
```sql
 n_dead_tup 
------------
          0
```

Размер файла таблицы: **407 MB**

## 6 
 выполнен скрипт (x5)

## 7

Число мёртвых записей: **5000000**

Размер таблицы: **438 MB**

## 8
```sql
ALTER TABLE test2 SET (autovacuum_enabled = false);
```

## 9 
выполнен скрипт (x10)

## 10
```sql
SELECT pg_size_pretty(pg_table_size('test2')) AS table_size;
```
ответ: **879 MB**

## 11
Обновлённые строки "оставляют" старые свои записи с пометкой "удалённые", поэтому первоначально размер БД вырос примерно в 6 раз (5 раз старая версия + 1 актуальная). 
После автовакуума старые версие "подтёрлись", но место не освободилось на диске. Поэтому при ещё 10 обновлениях с выключенным автовакуумом произошла запись ещё 5 старых версий, помимо заполнения прежних 5ти и в результате этого объём увеличился примерно в 11 раз от первоначального (толкьо есть погрешность на добавленные символ)
Если сделать `VACUUM FULL test2;` то размер таблицы будет  89 MB (вырос от первоначального из-за увеличения длины строки)

## 12 
```sql
ALTER TABLE test2 SET (autovacuum_enabled = true);
```

## ДОП ЗАДАНИЕ
(изначально делал процедуру с заменой последнего символа, но долго выполнялась, поэтому сделал просто добавление, пусть будет рост размера из-за увеличения длины строки, но это не так сильно влияет)
```sql
DO $$
DECLARE
    r RECORD;
    i INT;
BEGIN
    FOR i IN 1..10 LOOP
        RAISE NOTICE 'Step: %', i;  -- Вывод номера шага
        FOR r IN (SELECT id, val FROM test2) LOOP
            UPDATE test2
            SET val = r.val || 'b'
            WHERE id = r.id;
        END LOOP;
    END LOOP;
END $$;
```



### Текст ДЗ
1. Создать таблицу с текстовым полем и заполнить случайными или сгенерированными данным в размере 1 млн строк
2. Посмотреть размер файла с таблицей
3. 5 раз обновить все строчки и добавить к каждой строчке любой символ
4. Посмотреть количество мертвых строчек в таблице и когда последний раз приходил
   автовакуум
5. Подождать некоторое время, проверяя, пришел ли автовакуум
6. 5 раз обновить все строчки и добавить к каждой строчке любой символ
7. Посмотреть размер файла с таблицей
8. Отключить Автовакуум на конкретной таблице
9. 10 раз обновить все строчки и добавить к каждой строчке любой символ
10. Посмотреть размер файла с таблицей
11. Объясните полученный результат
12. Не забудьте включить автовакуум)
